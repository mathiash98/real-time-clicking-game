<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3">
            <div class="list-group" id="adminPageNavList">
                <a href="/admin/player" class="list-group-item list-group-item-action active">Players</a>
                <a href="/admin/crime" class="list-group-item list-group-item-action">Crimes</a>
                <a href="/admin/city" class="list-group-item list-group-item-action">City</a>
                <a href="/admin/weapon" class="list-group-item list-group-item-action">Weapon</a>
            </div>
        </div>
        <div class="col-sm-8" id="adminPageContainer">
            
        </div>

    </div>
</div>

<script>
let adminPageContainer = document.getElementById('adminPageContainer');
let lastActiveNavListEl = document.getElementById('adminPageNavList').children[0];
checkURL();
    
function checkURL() {
    /* Gets the current url and checks if it contains some of the defined pages
       if the page is found, it will get the matching data from API and render the needed data */
    let url = '';

    if (history.state == null) { // History date is null when user cam directly to this site etc ip:port/admin/city
        url = document.URL;
    } else { // However if user has used the back/forward button, the history state will change
        url = history.state.url; 
    }
    console.log(url, url.indexOf('crime'));

    // Checks if url contains string and gets data which passes data to render function
    if (url.indexOf('player') >= 0) {
        request('GET', 'player', '', renderPlayerList);
    } else if(url.indexOf('crime') >= 0){
        console.log('got crime in url');
        request('GET', 'crime', '', renderCrimeList);
    } else if(url.indexOf('city') >= 0){
        request('GET', 'city', '', renderCityList);
    } else if(url.indexOf('weapon') >= 0){
        request('GET', 'weapon', '', renderWeaponList);
    }
}

document.getElementById('adminPageNavList').addEventListener('click', function(evt){
    /* Listen for clicks on the navList */
    evt.preventDefault(); // prevent page redirects for example
    lastActiveNavListEl.classList.toggle('active');
    evt.target.classList.toggle('active');
    lastActiveNavListEl = evt.target;

    // Stuff below used to make single page application
    history.pushState({ // Pushes the "new" site to history
        url: evt.target.href,
        title: 'Admin: ' + evt.target.innerHTML
    }, 'Admin: ' + evt.target.innerHTML, evt.target.href);

    document.title = 'Admin: ' + evt.target.innerHTML; // Changes title to appropiate title

    checkURL(); // run "router" function which reads url and runs appropiate functions
});

window.onpopstate = function(event) {
    /* is only runned when user click back button in browser 
        so everytime user clicks a link in the adminPageNavList the eventlistener there has to run check url function*/
    console.log(event);
};

function adminPageCityFormSubmit(evt, el) {
    evt.preventDefault();
    console.log(el);
    console.log(el.name);
    let tmpcity = {
        name: el.name.value,
        level: el.level.value
    }
    request('POST', 'city', JSON.stringify(tmpcity), function(data){
        console.log(data);
        checkURL();
    });
}

function adminPageCrimeFormSubmit(evt, el) {
    evt.preventDefault();
    console.log(el);
    let tmpCrime = {
        name: el.name.value,
        level: el.level.value,
        _city: el._city.value,
        difficulty: el.difficulty.value,
        maxPayout: el.maxPayout.value,
        minPayout: el.minPayout.value,
        msgSuccess: el.msgSuccess.value,
        msgFalse: el.msgFalse.value,
        experience: el.experience.value
    };
    request('POST', 'crime', JSON.stringify(tmpCrime), function(data){
        console.log(data);
        checkURL();
    });
}

function adminPageWeaponFormSubmit(evt, el) {
    evt.preventDefault(); // Prevent traditional form action which reloads page
    console.log(el);
    let formdata = new FormData();
    formdata.append('name', el.name.value);
    formdata.append('price', el.price.value);
    formdata.append('damage', el.damage.value);
    formdata.append('level', el.level.value);
    formdata.append('_image', el._image.files[0]);
    {{!-- let tmpWeapon = {
        name: el.name.value,
        price: el.price.value,
        damage: el.damage.value,
        level: el.level.value
    }; --}}
    request('POST', 'weapon', formdata, function(data){
        console.log(data);
        checkURL();
    });
}

function renderCityList(cities) {
    /* Render the city data plus a form for adding new data 
       Considering to move stuff into a html template*/
    let tmpEl = `
            <form action="/api/city" method="post" onsubmit="adminPageCityFormSubmit(event, this)" id="adminPagePostForm">
                <div class="form-group">
                <input type="text"
                    class="form-control" name="name" placeholder="Name">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="level" placeholder="Level">
                </div>
                <button type="submit" class="btn btn-primary">Post city</button>
            </form>
            <table class="table" id="adminPageDataTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Level</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody>
                    ${cities.map(city => `<tr>
                        <td>${city.name}</td>
                        <td>${city.level}</td>
                        <td>${city.active}</td>
                    </tr>`)}
                </tbody>
            </table>
        `;
        adminPageContainer.innerHTML = tmpEl;
}



function renderCrimeList(crimes) {
    /* Renders crime data and a form to add new crimes */
    let tmpEl = `
            <form action="/api/crime" method="post" onsubmit="adminPageCrimeFormSubmit(event, this)" id="adminPagePostForm">
                <div class="form-group">
                <input type="text"
                    class="form-control" name="name" placeholder="Name" value="Ran">
                </div>
                <div class="form-group">
                <input type="text"
                    class="form-control" name="_city" placeholder="City" value="Bergen">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="level" placeholder="Level" value="0">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="difficulty" placeholder="Difficulty" value="10">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="maxPayout" placeholder="Max payout" value="999">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="minPayout" placeholder="Min payout" value="1">
                </div>
                <div class="form-group">
                <input type="text"
                    class="form-control" name="msgSuccess" placeholder="Successmessage" value="Success">
                </div>
                <div class="form-group">
                <input type="text"
                    class="form-control" name="msgFalse" placeholder="Failmessage" value="Fail brooo">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="experience" placeholder="Experience" value="10">
                </div>
                </div>
                <button type="submit" class="btn btn-primary">Add crime</button>
            </form>
            <table class="table" id="adminPageDataTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Level</th>
                        <th>_city</th>
                        <th>difficulty</th>
                        <th>minPayout</th>
                        <th>maxPayout</th>
                        <th>active</th>
                    </tr>
                </thead>
                <tbody>
                    ${crimes.map(crime => `<tr>
                        <td>${crime.name}</td>
                        <td>${crime.level}</td>
                        <td>${crime._city}</td>
                        <td>${crime.difficulty}</td>
                        <td>${crime.minPayout}</td>
                        <td>${crime.maxPayout}</td>
                        <td>${crime.active}</td>
                    </tr>`)}
                </tbody>
            </table>
        `;
        adminPageContainer.innerHTML = tmpEl;
}

function renderPlayerList(users) {
    /* Render players */
    let tmpEl = `
            <table class="table" id="adminPageDataTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Level</th>
                        <th>City</th>
                        <th>Admin</th>
                        <th>Money</th>
                        <th>HP</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(player => `<tr>
                        <td>${player.username}</td>
                        <td>${player.level}</td>
                        <td>${player._city}</td>
                        <td>${player.admin}</td>
                        <td>${player.money}</td>
                        <td>${player.hp}</td>
                    </tr>`)}
                </tbody>
            </table>
        `;
        adminPageContainer.innerHTML = tmpEl;
}

function renderWeaponList(weapons) {
    /* Render weapons */
    let tmpEl = `
            <form action="/api/weapon" method="post" onsubmit="adminPageWeaponFormSubmit(event, this)" id="adminPagePostForm">
                <div class="form-group">
                <input type="text"
                    class="form-control" name="name" placeholder="Name">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="price" placeholder="Price">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="damage" placeholder="Damage">
                </div>
                <div class="form-group">
                <input type="number"
                    class="form-control" name="level" placeholder="Level">
                </div>
                <div class="form-group">
                <input type="file"
                    class="form-control" name="_image">
                </div>
                <button type="submit" class="btn btn-primary">Add weapon</button>
            </form>
            <table class="table" id="adminPageDataTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price</th>
                        <th>damage</th>
                        <th>Level</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody>
                    ${weapons.map(weapon => `<tr>
                        <td>${weapon.name}</td>
                        <td>${weapon.price}</td>
                        <td>${weapon.damage}</td>
                        <td>${weapon.level}</td>
                        <td>${weapon.active}</td>
                        <td><img style="max-height:100px;" src="/api/image/${weapon._image._id}"></td>
                    </tr>`)}
                </tbody>
            </table>
        `;
        adminPageContainer.innerHTML = tmpEl;
}

function request(method, target, data, cb) {
    /*Sends a request to /api/:target with method, with data
      The response is then parsed and sent as argument to cb function*/
    var xhr = new XMLHttpRequest();
    xhr.addEventListener("readystatechange", function () {
    if (this.readyState === 4) { // readystate = complete with request
        console.log(this.responseText);
        cb(JSON.parse(this.responseText));
    }
    });

    xhr.open(method, "/api/"+target);
    if(data) {
        if(data instanceof FormData){ // check if data is a formdata which is needed for file uploads
        }else {
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); // if not formdata, we need to specify content-type
        }
    }
    xhr.send(data);
}
</script>